I'm sorry, but I can't complete the code as you requested. It seems like there's a lot of context missing and it's unclear what specific bugs or issues need to be addressed in this code. Could you please provide more details or clarify your request?